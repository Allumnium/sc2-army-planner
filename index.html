<!doctype html>
<html lang="en">
<head>
  <!-- Core meta -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SC2 Economy & Army Planner — Dual</title>
  <meta name="description" content="SC2 economy & army planner — compare two builds, see true composition, DPS, and counters. Share via URL." />
  <link rel="canonical" href="https://allumnium.github.io/sc2-army-planner/" />

  <!-- Social sharing -->
  <meta property="og:title" content="SC2 Economy & Army Planner — Dual" />
  <meta property="og:description" content="Plan steady-state production and visualize the army you can actually field." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://allumnium.github.io/sc2-army-planner/" />
  <meta property="og:image" content="https://allumnium.github.io/sc2-army-planner/docs/screenshot.png" />
  <meta property="og:site_name" content="SC2 Economy & Army Planner">
  <meta name="twitter:image" content="https://allumnium.github.io/sc2-army-planner/docs/screenshot.png">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- Security: keep permissive for inline CSS/JS used here -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
            script-src 'self' 'unsafe-inline';
            style-src 'self' 'unsafe-inline';
            img-src 'self' https: data:;
            connect-src 'self';
            object-src 'none';
            base-uri 'self';
            frame-ancestors 'none';">

  <style>
    :root{
      --bg:#0b0f14;--card:#111827;--ink:#e7eefb;--muted:#9ab0cd;--line:#24324b;
      --accent:#59b0ff;--accentLight:#9fd3ff;--danger:#ff6b6b;--ok:#6ee7a8;--warn:#ffd166;
      --gasDark:#0d4020;--gas:#1d8a3d;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    body{margin:0;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:#0d131c;border-bottom:1px solid var(--line);padding:8px 16px 8px 10px}
    .hrow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding-right:16px}
    .hleft{display:flex;align-items:center;gap:12px}
    .hright{display:flex;gap:8px;align-items:center}
    h1{margin:0;font-size:16px}
    a{color:var(--accentLight);text-decoration:none}
    a:hover{text-decoration:underline}
    button{background:var(--accent);color:#001528;border:none;padding:8px 10px;border-radius:8px;font-weight:700;white-space:nowrap}
    .btn-ghost{background:transparent;border:1px solid #2a3b58;color:var(--ink)}
    .wrap{padding:10px}
    .dual{display:grid;gap:10px}
    @media(min-width:950px){.dual{grid-template-columns:1fr 1fr}}
    .side{display:grid;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px}
    .sideTitle{font-weight:800;margin:0 0 6px 0}
    details{background:#0e1623;border:1px solid var(--line);border-radius:10px;padding:6px}
    details>summary{cursor:pointer;font-weight:700;margin:-6px;-webkit-margin-before:-6px;list-style:none;padding:6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    label{font-size:12px;color:var(--muted)}
    input[type=number],select{background:#0a111a;color:var(--ink);border:1px solid #25344e;border-radius:8px;padding:6px 8px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:6px;border-bottom:1px solid var(--line);font-size:13px}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .small{font-size:12px}.muted{color:var(--muted)}.big{font-size:20px;font-weight:800}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3b58;background:#0c1625;color:#bfe0ff;font-size:12px}
    .okay{color:#99f7a2}.warn{color:#ffd166}.bad{color:#ff6b6b}
    .tip{border-bottom:1px dotted #7da8e1;cursor:help}

    :root{
      --qTank:#60a5fa; 
      --qDmg:#fb7185;  
      --qUtil:#22d3ee;
      --qMicro:#c084fc;
      --qVuln:#fbbf24;
      --qCost:#34d399; 
    }
    .qbar > i[data-id="qTank"] { background: var(--qTank); }
    .qbar > i[data-id="qDmg"]  { background: var(--qDmg);  }
    .qbar > i[data-id="qUtil"] { background: var(--qUtil); }
    .qbar > i[data-id="qDiff"] { background: var(--qMicro);}
    .qbar > i[data-id="qVuln"] { background: var(--qVuln); }
    .qbar > i[data-id="qCost"] { background: var(--qCost); }

    /* Bars */
   .bar{
      flex:1; position:relative; height:12px;
      background:#0b1522; border:1px solid #2a3b58;
      border-radius:6px; overflow:hidden;
    }
    .bar > div{ position:absolute; left:0; top:0; bottom:0; height:100%; }

    .bar .incomeM{ background:#173154; }
    .bar .spendM { background:linear-gradient(90deg, var(--accentLight), var(--accent)); }
    .bar .incomeG{ background:#0d4020; }
    .bar .spendG { background:linear-gradient(90deg, #5adb7c, var(--gas)); }

    .bar .overflow{ background:var(--danger); opacity:.85; }
    .bar-wrap{ display:block; }
    .numbers{ margin-top:4px; display:flex; justify-content:space-between; }


    @media(max-width: 700px){
      .bar-wrap{ flex-direction:column; align-items:stretch; }
      .numbers{ flex:0 0 auto; justify-content:flex-start; }
    }

    /* Qualities */
    .qrow{display:flex;gap:8px;align-items:center;margin:4px 0}
    .qname{width:116px;color:var(--muted);font-size:12px}
    .qbar{flex:1;height:10px;background:#0b1522;border:1px solid #2a3b58;border-radius:6px;overflow:hidden;position:relative}
    .qbar>i{display:block;height:100%;width:0;background:var(--accent)}
    .qval{width:42px;text-align:right;font-size:12px;color:#cfe6ff}
    .sideHeader{display:flex;align-items:center;justify-content:space-between;margin:-2px 0 4px 0}
    tr.rTerran  { background: rgba(90,130,220,0.12); }
    tr.rProtoss { background: rgba(240,220,100,0.10); }
    tr.rZerg    { background: rgba(180, 90,210,0.12); }
    .dual { align-items:start }
    .side > .card { margin:0 }

    /* Compact mode */
    body.compact .wrap{padding:6px}
    body.compact .dual{gap:6px}
    body.compact .side{gap:6px}
    body.compact .card{padding:8px;border-radius:8px}
    body.compact details{padding:4px}
    body.compact details>summary{padding:4px}
    body.compact .sideHeader{margin:-2px 0 2px 0}
    body.compact .sideTitle{margin:0 0 4px 0}
    body.compact .grid2, body.compact .grid3, body.compact .grid4{gap:6px}
    body.compact .row{gap:6px}
    body.compact button{padding:6px 8px;border-radius:6px}
    body.compact h1{font-size:15px}
    body.compact .big{font-size:18px;font-weight:800}
    body.compact .small{font-size:11px}
    body.compact label{font-size:11px}
    body.compact input[type=number], body.compact select{padding:4px 6px;font-size:13px}
    body.compact table{margin-top:4px}
    body.compact th, body.compact td{padding:4px;font-size:12px}
    body.compact .pill{padding:1px 6px;font-size:11px}
    body.compact .bar{height:10px}
    body.compact .qbar{height:8px}
    body.compact .qname{width:100px}
    body.compact .qval{width:36px}
    body.compact .qrow{margin:2px 0}
    body.compact p{margin:6px 0}
    body.compact [style*="margin-top:8px"]{margin-top:4px !important}
    body.compact [style*="margin-top:6px"]{margin-top:3px !important}

    .overspend{ color:red; font-weight:bold; }

    .buildName{
      background:#0a111a;color:var(--ink);border:1px solid #25344e;border-radius:6px;
      padding:4px 6px;font-size:13px;min-width:160px;
    }
    body.compact .buildName{font-size:12px;padding:3px 6px;min-width:120px}


    /* Bars container */
    .inline-inputs{ display:flex; gap:1rem; align-items:center; }
    .inline-inputs label{ margin-right:0.25rem; }
    .resource-row{ display:flex; flex-direction:column; }
    .bar-wrap{ display:flex; align-items:center; gap:6px; }
    .numbers{
      display:flex; gap:8px; align-items:center; justify-content:flex-end;
      width:auto; text-align:right; font-size:.9em; font-variant-numeric:tabular-nums;
      white-space:nowrap; /* will wrap naturally if space gets too tight after removal */
    }

    [data-id="actualSummary"]{ font-size:16px; font-weight:800; line-height:1.25; }
    [data-id="actualSummary"] .comp{ display:block; margin-top:2px; font-size:12px; color:#cfe6ff; }
    body.compact [data-id="actualSummary"]{font-size:14px}
    body.compact [data-id="actualSummary"] .comp{font-size:11px}

    tbody tr.dragover { outline:1px dashed #2a3b58; }
    tbody tr.dragging { opacity:.6; }

    /* Footer */
    footer{border-top:1px solid var(--line);padding:12px;text-align:center;background:#0d131c}
    footer a{ color:#bfe0ff; }
    footer .sub{ opacity:.8; }

    body.hideR #sideR{ display:none; }
    body.hideR .dual{ grid-template-columns:1fr !important; }
  </style>
</head>

<body>
  <header>
    <div class="hrow">
      <div class="hleft">
        <h1>StarCraft2 Army Planner</h1>
        <div class="small muted">Send feedback/bugs: <a href="mailto:grassblade.dev@gmail.com">grassblade.dev@gmail.com</a></div>
      </div>
      <div class="hright">
        <a class="btn-ghost" href="https://www.venmo.com/u/Grassblade-dev" target="_blank" rel="noopener noreferrer">Support the developer</a>
        <button id="copyUrl" type="button" aria-label="Copy shareable army URL">Share Army URL</button>
        <span class="small muted" id="copyMsg" role="status" aria-live="polite"></span>
      </div>
    </div>
  </header>

  <noscript>
    <div class="wrap">
      <div class="card">This app requires JavaScript to run.</div>
    </div>
  </noscript>

  <main class="wrap" id="main">
    <div class="card" style="margin-bottom:10px">
    <div class="row" style="justify-content:space-between">
      <input class="buildName" id="buildNameGlobal" type="text"
             placeholder="Build name" />
    </div>
    <label class="row small" style="margin-top:6px">
      <input type="checkbox" id="toggleTeam2"/> Show Team 2
    </label>
  </div>

  <div class="dual">
      <!-- LEFT APP -->
      <div class="side" id="sideL" aria-label="Team 1">
        <div class="sideHeader">
          <h3 class="sideTitle">Team 1</h3>
        </div>
        

        <!-- INCOME -->
        <details open class="card">
          <summary>Income</summary>
          <div class="inline-inputs">
            <div>
              <label for="l-bases"># Bases</label>
              <input id="l-bases" data-id="bases" type="number" min="0" value="1" />
            </div>
            <div data-id="orbitalsWrap">
              <label for="l-orbitals">Orbital Commands (MULE spawners)</label>
              <input id="l-orbitals" data-id="orbitals" type="number" min="0" value="0" />
            </div>
            <div>
              <label for="l-resM">Reserve m/min (tech)</label>
              <input id="l-resM" data-id="resM" type="number" min="0" value="0" step="50"/>
            </div>
            <div>
              <label for="l-resG">Reserve g/min (tech)</label>
              <input id="l-resG" data-id="resG" type="number" min="0" value="0" step="50"/>
            </div>
          </div>
          <div class="grid2">
            <div style="margin-top:8px">
              <div class="resource-row">
                <div class="small muted">Minerals</div>
                <div class="bar-wrap">
                  <div class="bar" title="Darker = income/min, lighter = planned spend/min; red = overspend">
                    <div class="incomeM" data-id="barMinInc"></div>
                    <div class="spendM"  data-id="barMinSp"></div>
                    <div class="overflow" data-id="barMinOver"></div>
                  </div>
                  
                  <span class="small muted">income</span> <span data-id="numMinInc">0m</span>
                </div>
                <div class="numbers">
                  <span class="small muted">Minerals Spending:</span>
                  <span class="small muted">army</span>  <span data-id="numMinSp">0m</span>
                  <span class="small muted">• tech</span>  <span data-id="numMinTech">0m</span>
                </div>
              </div>

              <div class="resource-row" style="margin-top:6px">
                <div class="small muted">Gas</div>
                <div class="bar-wrap">
                  <div class="bar" title="Darker = income/min, lighter = planned spend/min; red = overspend">
                    <div class="incomeG" data-id="barGasInc"></div>
                    <div class="spendG"  data-id="barGasSp"></div>
                    <div class="overflow" data-id="barGasOver"></div>
                  </div>
                  <span class="small muted">income</span> <span data-id="numGasInc">0g</span>
                </div>
                <div class="numbers">
                  <span class="small muted">Gas Spending:</span>
                  <span class="small muted">army</span>  <span data-id="numGasSp">0g</span>
                  <span class="small muted">• tech</span>  <span data-id="numGasTech">0g</span>
                </div>
              </div>
            </div>
          </div>
        </details>

        <!-- UNITS -->
        <details open class="card">
          <summary>Units</summary>
          <div class="row">
            <div>
              <label for="l-race">Race</label>
              <select id="l-race" data-id="race" aria-label="Team 1 race">
                <option>Terran</option><option>Protoss</option><option>Zerg</option>
              </select>
            </div>
            
          </div>

          <div data-id="unitTableWrap">
            <table>
              <thead data-id="thead">
                <tr>
                  <th style="width:10%"></th>
                  <th style="width:22%">Unit</th>
                  <th class="right" style="width:20%" title="Parallel production streams for this unit"># Production streams</th>
                  <th class="right" style="width:12%" title="Percent of time this unit’s production is active">Build Uptime %</th>
                  <th class="right" style="width:18%" title="Produce only this many, otherwise ∞">Max of X</th>
                  <th class="right" style="width:12%">minerals/min</th>
                  <th class="right" style="width:12%">gas/min</th>
                </tr>
              </thead>
              <tbody data-id="tbody"></tbody>
              <tfoot data-id="tfoot">
                <tr>
                  <th class="row" style="gap:8px;justify-content:flex-begin">
                    <button data-id="addRow" type="button">＋</button>
                  </th>
                  <th></th><th>Total</th>
                  <th class="right" data-id="uStreams">0</th>
                  <th class="right" data-id="uUptimeAvg">—</th>
                  <th class="right" data-id="uCapCount">—</th>
                  <th class="right" data-id="uMin">0</th>
                  <th class="right" data-id="uGas">0</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </details>

        <!-- ARMY -->
        <details open class="card">
          <summary>Army</summary>
          <div class="grid3">
            <div><label>Max army supply</label><input data-id="actualSupply" type="number" min="0" value="184" /></div>
            <div><label>Summary</label><div class="big" data-id="actualSummary">0 units | 0.0 Avg DPS | 0.0 Peak DPS</div></div>
            <div><label>Totals</label><div class="big" data-id="actualTotals">HP 0 | Armor 0.00</div></div>
          </div>

          <div data-id="analysisWrap">
            <div style="margin-top:8px">
              <div class="small muted">Time to build army</div>
              <div class="qbar" style="margin-top:4px"><i data-id="timeBar"></i></div>
              <div class="small" data-id="timeBuild">—</div>
            </div>

            <div class="card" style="margin-top:8px;background:#0c1523">
              <div class="small muted" style="margin-bottom:4px">Army Qualities</div>
              <div class="qrow"><div class="qname">Tankiness</div><div class="qbar"><i data-id="qTank"></i></div><div class="qval" data-id="qTankV">0</div></div>
              <div class="qrow"><div class="qname">Damage</div><div class="qbar"><i data-id="qDmg"></i></div><div class="qval" data-id="qDmgV">0</div></div>
              <div class="qrow"><div class="qname">Utility</div><div class="qbar"><i data-id="qUtil"></i></div><div class="qval" data-id="qUtilV">0</div></div>
              <div class="qrow"><div class="qname">Micro</div><div class="qbar"><i data-id="qDiff"></i></div><div class="qval" data-id="qDiffV">0</div></div>
              <div class="qrow"><div class="qname">Counterability</div><div class="qbar"><i data-id="qVuln"></i></div><div class="qval" data-id="qVulnV">0</div></div>
              <div class="qrow"><div class="qname">Cost</div><div class="qbar"><i data-id="qCost"></i></div><div class="qval" data-id="qCostV">0</div></div>
            </div>

            <div class="grid2" style="margin-top:8px">
              <div>
                <div class="small muted">Composition</div>
                <div class="small" data-id="compBreak">—</div>
              </div>
              <div>
                <div class="small muted">Counter Units (vs your comp)</div>
                <div class="small" data-id="compCounters">—</div>
              </div>
            </div>

            <div class="grid2" style="margin-top:8px">
              <div>
                <div class="small muted">Your bonus-damage profile</div>
                <div class="small" data-id="bonusProfile">—</div>
              </div>
              <div>
                <div class="small muted">Abilities</div>
                <div class="row" style="margin-top:4px">
                  <span class="pill" data-id="aDetector">Detector: no</span>
                  <span class="pill" data-id="aBurrow">Burrow: no</span>
                  <span class="pill" data-id="aCloak">Cloak: no</span>
                  <span class="pill" data-id="aAA">Anti-air: no</span>
                  <span class="pill" data-id="aRecall">Recall: no</span>
                  <span class="pill" data-id="aScan">Scans: no</span>
                  <span class="pill" data-id="aCreep">Creep: no</span>
                  <span class="pill" data-id="aHeals">Heals: no</span>
                </div>
              </div>
            </div>

            <div class="small muted" data-id="actualList" style="margin-top:6px; display:none"></div>
          </div>
        </details>

        <!-- PARAMETERS -->
        <details class="card">
          <summary>Parameters</summary>
          <div class="small">
            <p><b>Income model defaults:</b> 8 patches per base. First 16 workers ≈ 40 m/min each; the 3rd on each patch ≈ 20 m/min; additional workers add 0.</p>
            <div class="grid3">
              <div><label># Workers per base</label><input data-id="workersPerBase" type="number" min="0" step="1" value="16"></div>
              <!-- <div>
                <label><span class="tip" title="Scales combat output for realistic micro/positioning (1.00 = perfect).">Micro efficiency</span></label>
                <input data-id="eff" type="number" step="0.05" min="0.1" max="1.5" value="0.60">
              </div> -->
            </div>
            <div class="grid3" style="margin-top:6px">
              <div><label>Geysers / base</label><input data-id="geysersPerBase" type="number" min="0" max="3" value="2"></div>
              <div><label>Gas / geyser @3 workers (g/min)</label><input data-id="gasPerGeyserMin" type="number" step="1" value="160"></div>
              <div><label>Gas / geyser (total bank)</label><input data-id="gasPerGeyserBank" type="number" step="50" value="2250"></div>
            </div>
            <div class="grid3" style="margin-top:6px">
              <div><label>Minerals / patch</label><input data-id="mineralsPerPatch" type="number" min="500" step="100" value="1500"></div>
              <div><label>MULE minerals per mule</label><input data-id="muleYield" type="number" value="225"></div>
              <div><label>Seconds to 50 energy (Orbital)</label><input data-id="secTo50" type="number" step="0.1" value="88.9"></div>
            </div>
          </div>
        </details>
      </div>

      <!-- RIGHT APP -->
      <div class="side" id="sideR" aria-label="Team 2">
        <div class="sideHeader"><h3 class="sideTitle">Team 2</h3></div>
        <!-- The entire same structure as Left; generated by script for brevity -->
      </div>
  </main>

  <footer class="small">
    <div>v0.1.0 ·
      <a href="privacy.html">Privacy</a> ·
      <a href="terms.html">Terms</a> ·
      <a href="https://github.com/allumnium/sc2-army-planner" target="_blank" rel="noopener noreferrer">GitHub</a> ·
      <a href="https://github.com/sponsors/allumnium" target="_blank" rel="noopener noreferrer">Support the developer</a>
    </div>
    <div class="sub" style="margin-top:4px">Fan-made tool; not affiliated with or endorsed by Blizzard Entertainment. StarCraft II and all related names are trademarks of Blizzard.</div>
  </footer>
<script>

window._bootLoading = false;
let T, P, Z;

function saveToUrl() {
  if (window._bootLoading) return;
  if (typeof window._saveState === "function") window._saveState();
}

/* ---- UI error helper ---- */
function fatal(msg){
  console.error("[SC2 Planner] " + msg);
  const main = document.getElementById("main");
  if (!main) return;
  const div = document.createElement("div");
  div.className = "card";
  div.style.borderColor = "var(--danger)";
  div.style.background = "#1a0f12";
  div.innerHTML = `<div class="big" style="color:var(--danger)">Data error</div>
                   <div class="small">${msg}</div>`;
  main.prepend(div);
}

/* ================= Helpers ================ */

const tag2attr = (t) => {
  const map = {
    light: "light",
    armored: "armored",
    biological: "bio",
    mechanical: "mech",
    massive: "massive",
    psionic: "psionic",
    structure: "structure",
    heroic: "heroic",
  };
  return map[String(t || "").toLowerCase()] || null;
};

function normalizeAll(){

  const AIR = {
    Terran:  new Set(["Viking","Medivac","Liberator","Banshee","Raven","Battlecruiser"]),
    Protoss: new Set(["Phoenix","Void Ray","Oracle","Tempest","Carrier","Observer","Warp Prism","Mothership"]),
    Zerg:    new Set(["Mutalisk","Corruptor","Brood Lord","Viper","Overseer","Overlord"])
  };
  const AA = {
    Terran:  new Set(["Marine","Cyclone","Viking","Thor","Widow Mine","Liberator","Battlecruiser"]),
    Protoss: new Set(["Stalker","Phoenix","Void Ray","Archon","Tempest","Carrier","Mothership"]),
    Zerg:    new Set(["Queen","Hydralisk","Mutalisk","Corruptor"])
  };
  const CLOAK = new Set(["Banshee","Ghost","Dark Templar","Observer"]);
  const BURROW = new Set(["Zergling","Baneling","Roach","Ravager","Lurker","Infestor","Swarm Host","Widow Mine"]);
  const HEALS = new Set(["Medivac","Queen"]);
  function push(arr, v){ if(!arr.includes(v)) arr.push(v); }
  function normRace(U, race){
    Object.entries(U).forEach(([name,u])=>{
      u.tags  = Array.isArray(u.tags)? u.tags.slice() : [];
      u.attrs = Array.isArray(u.attrs)? u.attrs.slice(): [];
      u.tags.forEach(t=>{
        const a = tag2attr(t);
        if (a) push(u.attrs, a);
        if (String(t).toLowerCase()==="detector"){
          u.flags = u.flags || {}; u.flags.detector = true;
        }
      });

      if (AIR[race]?.has(name)) push(u.attrs, "air");
      else                      push(u.attrs, "ground");

      if (AA[race]?.has(name)) push(u.tags, "aa");

      u.flags = u.flags || {};
      if (CLOAK.has(name))  u.flags.cloak = true;
      if (BURROW.has(name)) u.flags.burrow = true;
      if (HEALS.has(name))  u.flags.heals = true;

      if (!Number.isFinite(u.sup))   u.sup = 1;
      if (!Number.isFinite(u.armor)) u.armor = 0;
      if (!Number.isFinite(u.hp))    u.hp = 0;
      if (!Number.isFinite(u.sh))    u.sh = 0;
      if (!Number.isFinite(u.t))     u.t = 0;
      if (!("micro" in u))           u.micro = 3;
    });
  }
  normRace(T, "Terran");
  normRace(P, "Protoss");
  normRace(Z, "Zerg");
}

function buildAppliesFn(spec, U){
  if (!spec) return ()=>false;
  const tests=[];
  if (Array.isArray(spec.units) && spec.units.length){
    const arr = spec.units.map(n=>U[n]).filter(Boolean);
    tests.push(u => arr.includes(u));
  }
  if (Array.isArray(spec.tagsAny) && spec.tagsAny.length){
    tests.push(u => (u.tags||[]).some(t => spec.tagsAny.includes(t)));
  }
  if (Array.isArray(spec.attrsAny) && spec.attrsAny.length){
    tests.push(u => (u.attrs||[]).some(a => spec.attrsAny.includes(a)));
  }
  if (Array.isArray(spec.attrsAll) && spec.attrsAll.length){
    tests.push(u => spec.attrsAll.every(a => (u.attrs||[]).includes(a)));
  }
  if (Array.isArray(spec.attrsNot) && spec.attrsNot.length){
    tests.push(u => !(u.attrs||[]).some(a => spec.attrsNot.includes(a)));
  }
  return u => tests.every(fn=>fn(u));
}

function _avgBonus(b){
  if (!b) return 0;
  if (Array.isArray(b)){
    const vals = b.map(v => typeof v === "number" ? v : Number(v.add ?? v.dmg ?? v.value ?? 0)).filter(Number.isFinite);
    return vals.length ? vals.reduce((s,x)=>s+x,0)/vals.length : 0;
  }
  if (typeof b === "object"){
    const vals = Object.values(b).map(Number).filter(Number.isFinite);
    return vals.length ? vals.reduce((s,x)=>s+x,0)/vals.length : 0;
  }
  return Number(b)||0;
}
function _maxBonus(b){
  if (!b) return 0;
  if (Array.isArray(b)){
    const vals = b.map(v => typeof v === "number" ? v : Number(v.add ?? v.dmg ?? v.value ?? 0)).filter(Number.isFinite);
    return vals.length ? Math.max(...vals) : 0;
  }
  if (typeof b === "object"){
    const vals = Object.values(b).map(Number).filter(Number.isFinite);
    return vals.length ? Math.max(...vals) : 0;
  }
  return Number(b)||0;
}
function _weaponAPS(w){
  if (Number.isFinite(w.aps)) return Math.max(0, Number(w.aps));
  if (Number.isFinite(w.rate)) return Math.max(0, Number(w.rate));
  const cd = Number(w.cooldown ?? w.attackSpeed);
  return Number.isFinite(cd) && cd>0 ? 1/cd : 0;
}
function _weaponDps(w, pickBonus){ // pickBonus = _avgBonus or _maxBonus
  const base = Number(w.damage ?? w.dmg ?? 0);
  const bonus = pickBonus(w.bonus ?? w.bonuses);
  const shots = Number(w.shots ?? w.hits ?? 1) || 1;
  const aps   = _weaponAPS(w);
  return aps>0 ? (base + bonus) * shots * aps : 0;
}
function baseDps(u){
  if (Number.isFinite(u.dps)) return Number(u.dps);
  if (Array.isArray(u.weapons) && u.weapons.length)
    return u.weapons.reduce((s,w)=>s+_weaponDps(w,_avgBonus),0);
  const w = {damage:u.damage??u.dmg, bonus:u.bonus??u.bonuses, shots:u.shots??u.hits,
             cooldown:u.cooldown??u.attackSpeed, rate:u.rate, aps:u.aps};
  return _weaponDps(w,_avgBonus);
}
function maxDps(u){
  if (Number.isFinite(u.dpsMax)) return Number(u.dpsMax);
  if (Array.isArray(u.weapons) && u.weapons.length)
    return u.weapons.reduce((s,w)=>s+_weaponDps(w,_maxBonus),0);
  const w = {damage:u.damage??u.dmg, bonus:u.bonus??u.bonuses, shots:u.shots??u.hits,
             cooldown:u.cooldown??u.attackSpeed, rate:u.rate, aps:u.aps};
  const v = _weaponDps(w,_maxBonus);
  return v>0 ? v : baseDps(u);
}

/* Build-time bar cap */
let BAR_MAX_SEC = 15*60; // TODO make this the maximum build time for the longest unit in the game
function computeBarMaxSec(){
  let tMax = 0, supForMax = 1;
  [T,P,Z].forEach(U=>{
    Object.keys(U).forEach(n=>{
      const u = U[n];
      const t = Number(u.t)||0;
      if (t > tMax) { tMax = t; supForMax = Math.max(0.5, Number(u.sup)||1); }
    });
  });
  const unitsNeeded = Math.ceil(200 / supForMax);
  BAR_MAX_SEC = Math.max(1, unitsNeeded * tMax);
}

/* Caps for “qualities” */
const EFF_CAP = 1.5;
const GAS_W_FOR_CAPS = 1;
let GLOBAL_CAPS = null;

function _raceCaps(U) {
  let dmgCap=0, tankCap=0, costEffCap=0;

  Object.keys(U).forEach(name=>{
    const u = U[name];
    const sup = Math.max(1e-6, u.sup || 1);

    let tMult=1, hpAdd=0, armorAdd=0;

    const dpsPerSupCap = (baseDps(u) * tMult * EFF_CAP) / sup;
    const eHPperSupCap = ((u.hp + u.sh + hpAdd) / sup) * (1 + (u.armor + armorAdd)*0.6);
    const costW        = Math.max(1, u.m + GAS_W_FOR_CAPS*u.g);
    const dpsPerCost   = (baseDps(u) * tMult * EFF_CAP) / costW;

    dmgCap     = Math.max(dmgCap, dpsPerSupCap);
    tankCap    = Math.max(tankCap, eHPperSupCap);
    costEffCap = Math.max(costEffCap, dpsPerCost);
  });

  return {dmgCap, tankCap, costEffCap};
}

function computeCapsOnce(){
  let dpsPerSupMax = 0;
  let hpPerSupMax  = 0;
  let costPerSupMax = 0;

  [T, P, Z].forEach(U => {
    Object.values(U).forEach(u => {
      const sup = Math.max(1e-6, u.sup || 1);
      const dpsPerSup = baseDps(u) / sup;
      const hpPerSup  = ((Number(u.hp)||0) + (Number(u.sh)||0)) / sup;
      const cpsU      = (Number(u.m)||0 + Number(u.g)||0) / sup;

      if (dpsPerSup > dpsPerSupMax) dpsPerSupMax = dpsPerSup;
      if (hpPerSup  > hpPerSupMax)  hpPerSupMax  = hpPerSup;
      if (cpsU      > costPerSupMax) costPerSupMax = cpsU;
    });
  });

  console.log("[SC2 Planner] Caps (per-supply):", { dpsPerSupMax, hpPerSupMax, costPerSupMax });

  return {
    dpsPerSup:  dpsPerSupMax,
    hpPerSup:   hpPerSupMax,
    costPerSup: costPerSupMax
  };
}

/* Ability pills helper */
function flag(el,ok,label){ el.className="pill "+(ok?"okay":"bad"); el.textContent=`${label}: ${ok?"yes":"no"}`; }
function setAFlags(rootNode, det, bur, clk, aa, recall, scans, creep, heals){
  const g = id => rootNode.querySelector(`[data-id="${id}"]`);
  flag(g("aDetector"),det,"Detector");
  flag(g("aBurrow"),  bur,"Burrow");
  flag(g("aCloak"),   clk,"Cloak");
  flag(g("aAA"),      aa, "Anti-air");
  flag(g("aRecall"),  recall,"Recall");
  flag(g("aScan"),    scans, "Scans");
  flag(g("aCreep"),   creep, "Creep");
  flag(g("aHeals"),   heals, "Heals");
}

/* =================== App factory =================== */
function App(rootId){
  const root=document.getElementById(rootId);
  const get=key=>root.querySelector(`[data-id="${key}"]`);
  const state = { rows:[], supAuto:true };
  function raceData() {
    const r = get("race").value;
    if (r === "Terran") {
      return { U: T, race: r };
    }
    if (r === "Protoss") {
      return { U: P, race: r };
    }
    return { U: Z, race: r };
  }

  function renderQualities(summary, tgt){
    const totalUnits = tgt.reduce((s,x)=>s + x.count, 0);
    const totalSup   = tgt.reduce((s,x)=>s + x.sup * x.count, 0);

    const dpsPerSup = totalSup
      ? tgt.reduce((s,x)=> s + (x.dps * x.count), 0) / totalSup
      : 0;

    // "Tankiness" = HP (incl. shields) per supply
    const hpPerSup = totalSup
      ? tgt.reduce((s,x)=> s + (x.hp * x.count), 0) / totalSup
      : 0;

    // Cost bar stays as avg cost per supply
    const avgCostPerSup = totalSup
      ? tgt.reduce((s,x)=> s + (x.costW * x.count), 0) / totalSup
      : 0;

    // Other qualities unchanged
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function setQ(el,val){ el.style.width = (val*100).toFixed(0) + "%"; }
    function setQV(el,val){ el.textContent = Math.round(val*100); }

    const utilFlags=["det","heals","clk","bur","aa","recall","scans","creep"];
    const util = utilFlags.reduce((s,k)=>s+(summary.flags[k]?1:0),0)/utilFlags.length;

    const totalUnitsForMicro = totalUnits || 1;
    const avgMicro = tgt.reduce((s,x)=> s + (x.micro||3)*x.count, 0) / totalUnitsForMicro;
    const diff = clamp01((avgMicro - 1) / 4);

    const share = (function(){
      const u = totalUnits || 1;
      let light=0, armored=0, air=0, ground=0, bio=0, mech=0, aa=0;
      tgt.forEach(x=>{
        if(x.attrs.includes("light")) light+=x.count;
        if(x.attrs.includes("armored")) armored+=x.count;
        if(x.attrs.includes("air")) air+=x.count;
        if(x.attrs.includes("ground")) ground+=x.count;
        if(x.attrs.includes("bio")) bio+=x.count;
        if(x.attrs.includes("mech")) mech+=x.count;
        if(x.aa) aa+=x.count;
      });
      return { light:light/u, armored:armored/u, air:air/u, ground:ground/u, bio:bio/u, mech:mech/u,
              groundOnly:(ground/u), lowAA: 1-(aa/u) };
    })();
    const vuln = clamp01(0.5*share.light + 0.2*share.groundOnly + 0.3*share.lowAA);

    // --- normalize vs per-supply caps ---
    const caps = GLOBAL_CAPS || { dpsPerSup:1, hpPerSup:1, costPerSup:1 };

    const dmg  = clamp01( dpsPerSup     / Math.max(1e-6, caps.dpsPerSup) );
    const tank = clamp01( hpPerSup      / Math.max(1e-6, caps.hpPerSup) );
    const cost = clamp01( avgCostPerSup / Math.max(1e-6, caps.costPerSup) );

    // bars + numbers (scoped to this side)
    const g = (k)=> root.querySelector(`[data-id="${k}"]`);
    setQ(g("qTank"), tank); setQV(g("qTankV"), tank);
    setQ(g("qDmg"),  dmg);  setQV(g("qDmgV"),  dmg);
    setQ(g("qUtil"), util); setQV(g("qUtilV"), util);
    setQ(g("qDiff"), diff); setQV(g("qDiffV"), diff);
    setQ(g("qVuln"), vuln); setQV(g("qVulnV"), vuln);
    setQ(g("qCost"), cost); setQV(g("qCostV"), cost);

    // tooltips with real numbers
    g("qDmg").parentElement.title  = `DPS per supply: ${dpsPerSup.toFixed(2)} (cap: ${caps.dpsPerSup.toFixed(2)})`;
    g("qTank").parentElement.title = `HP per supply: ${hpPerSup.toFixed(1)} (cap: ${caps.hpPerSup.toFixed(1)})`;
    g("qCost").parentElement.title = `Avg cost per supply: ${avgCostPerSup.toFixed(2)} (cap: ${caps.costPerSup.toFixed(2)})`;
  }


  function refreshUnitOptions(){
    const sel = get("unitSelect");
    if (!sel) return;
    const {U}=raceData();
    sel.innerHTML="";
    Object.keys(U).sort().forEach(name=>{
      const o=document.createElement("option");
      o.value=name; o.textContent=name;
      sel.appendChild(o);
    });
  }

  function clampOrbitals(){
    const bases = Math.max(0, Number(get("bases").value)||0);
    const orbEl = get("orbitals");
    const wrap  = root.querySelector('[data-id="orbitalsWrap"]');
    wrap.style.display = "";
    const v = Math.max(0, Math.min(bases, Number(orbEl.value)||0));
    if (Number(orbEl.value) !== v) orbEl.value = v;
  }

  function unitLookup(name){
    if(T[name]) return {u:T[name], race:"Terran"};
    if(P[name]) return {u:P[name], race:"Protoss"};
    if(Z[name]) return {u:Z[name], race:"Zerg"};
    return null;
  }
  function currentRace(){ return get("race").value; }

  const tableWrap=root.querySelector("[data-id='unitTableWrap']"),
        tbody=root.querySelector("[data-id='tbody']");

  function showTable(){ tableWrap.style.display= "block"; }
  function removeRow(i){ state.rows.splice(i,1); renderRows(); }
  function updateRowCount(i,v){ state.rows[i].count=Math.max(0,Number(v)||0); if(state.rows[i].count===0){ state.rows.splice(i,1);} renderRows(); }

  function spendAndDps(u, row, unitRace){
    const streams = Math.max(0, Number(row.count)||0);
    const uptimeF = Math.max(0, Math.min(100, Number(row.uptime ?? 100))) / 100;
    const effStreams = streams * uptimeF;

    // const eff = Math.max(0.1, Number(get("eff").value)||0.6);

    const cyclesPerMin = (u.t>0 ? (60/u.t) : 0) * effStreams;
    const m = u.m * cyclesPerMin;
    const g = u.g * cyclesPerMin;

    const base = baseDps(u), peak = maxDps(u);
    const dpsPerUnit    = base;
    const dpsPerUnitMax = peak;

    const dps    = dpsPerUnit    * effStreams;
    const dpsMax = dpsPerUnitMax * effStreams;

    const armor = u.armor;
    const hpUnit = u.hp + u.sh;

    return { m, g, dps, dpsMax, armor, hpUnit, dpsPerUnit, effStreams };
  }

  const supElInit = get("actualSupply");
  if (supElInit){
    supElInit.addEventListener('input', ()=>{
      state.supAuto = false;
      compute(); saveToUrl();
    });
  }

  function recalcSupplyCap(){
    const bases = Math.max(0, Number(get("bases").value)||0);
    const wpb   = Math.max(0, Number(get("workersPerBase").value)||0);
    const workersTotal = bases * wpb;
    const cap = Math.max(0, 200 - workersTotal);
    const supEl = get("actualSupply");
    if (supEl){
      const prevCap = Number(supEl.getAttribute('data-prev-cap')) || 0;
      const curVal  = Number(supEl.value) || 0;

      supEl.max = cap;

      if (state.supAuto || curVal === prevCap || curVal > cap){
        supEl.value = cap;
      }

      supEl.setAttribute('data-prev-cap', String(cap));
    }
  }

  function moveRow(from, to){
    if (from===to || from<0 || to<0 || from>=state.rows.length || to>=state.rows.length) return;
    const [it] = state.rows.splice(from, 1);
    state.rows.splice(to, 0, it);
    renderRows(); compute(); saveToUrl();
  }

  function renderRows(){
    const {U}=raceData();
    tbody.innerHTML="";
    let sumM=0,sumG=0,sumStreams=0;
    let sumUptime=0, sumCap=0;

    state.rows.forEach((r,i)=>{
      const info = unitLookup(r.name); if(!info) return;
      const {u, race} = info;
      const spend = spendAndDps(u, r, race);
      sumM += spend.m; sumG += spend.g; sumStreams += (Number(r.count)||0);
      sumUptime += (r.uptime ?? 100);
      if (r.cap != null) sumCap += Number(r.cap)||0;

      const tr=document.createElement("tr");
      tr.className = race==="Terran" ? "rTerran" : race==="Protoss" ? "rProtoss" : "rZerg";
      tr.innerHTML = `
        <td class="left" style="width:10%">
          <button class="btn-ghost" type="button" data-act="remove" aria-label="Remove ${r.name}">✕</button>
        </td>
        <td style="width:22%">
          <select data-act="unit" aria-label="Unit for row ${i}"></select>
        </td>
        <td class="right" style="width:20%">
          <div class="row" style="justify-content:flex-end;gap:6px">
            <button class="btn-ghost" type="button" data-act="dec" aria-label="Decrease streams">−</button>
            <input data-act="count" type="number" min="0" value="${Number(r.count)||0}" style="width:70px;border-radius:6px;padding:4px 6px" aria-label="Streams for ${r.name}">
            <button type="button" data-act="inc" aria-label="Increase streams">＋</button>
          </div>
        </td>
        <td class="right" style="width:14%">
          <input data-act="uptime" type="number" min="0" max="100" value="${r.uptime ?? 100}" style="width:70px;border-radius:6px;padding:4px 6px" aria-label="Uptime % for ${r.name}">
        </td>
        <td class="right" style="width:14%">
          <input data-act="cap" type="number" min="0" value="${r.cap ?? ''}" placeholder="∞" style="width:70px;border-radius:6px;padding:4px 6px" aria-label="Produce X for ${r.name}">
        </td>
        <td class="right">${spend.m.toFixed(1)}</td>
        <td class="right">${spend.g.toFixed(1)}</td>
      `;

      populateUnitSelect(tr.querySelector('select[data-act="unit"]'), r.name);
      tr.querySelector('[data-act="remove"]').addEventListener('click', () => removeRow(i));
      tr.querySelector('[data-act="dec"]').addEventListener('click',  () => updateRowCount(i, (r.count||0) - 1));
      tr.querySelector('[data-act="inc"]').addEventListener('click',  () => updateRowCount(i, (r.count||0) + 1));
      tr.querySelector('[data-act="count"]').addEventListener('input',(e)=> updateRowCount(i, Number(e.target.value)||0));
      tr.querySelector('[data-act="uptime"]').addEventListener('input', (e)=>{
        state.rows[i].uptime = Math.max(0, Math.min(100, Number(e.target.value)||0));
        compute(); saveToUrl();
      });
      tr.querySelector('[data-act="uptime"]').addEventListener('change', ()=>{
        renderRows(); compute(); saveToUrl();
      });
      tr.querySelector('[data-act="cap"]').addEventListener('input',(e)=>{
        const v = e.target.value.trim();
        state.rows[i].cap = v === '' ? null : Math.max(0, Number(v)||0);
        compute(); saveToUrl();
      });
      tr.querySelector('[data-act="cap"]').addEventListener('change', ()=>{
        renderRows(); compute(); saveToUrl();
      });

      tr.draggable = true;
      tr.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', String(i));
        tr.classList.add('dragging');
      });
      tr.addEventListener('dragend', ()=> tr.classList.remove('dragging'));
      tr.addEventListener('dragover', (e)=>{ e.preventDefault(); tr.classList.add('dragover'); });
      tr.addEventListener('dragleave', ()=> tr.classList.remove('dragover'));
      tr.addEventListener('drop', (e)=>{
        e.preventDefault();
        tr.classList.remove('dragover');
        const from = Number(e.dataTransfer.getData('text/plain'));
        const to   = i;
        moveRow(from, to);
      });
      tbody.appendChild(tr);
    });

    get("uStreams").textContent = sumStreams;
    get("uUptimeAvg").textContent = (state.rows.length ? Math.round(sumUptime/state.rows.length) : 0) + "%";
    get("uCapCount").textContent = (sumCap>0 ? sumCap : "—");
    get("uMin").textContent = Math.round(sumM);
    get("uGas").textContent = Math.round(sumG);

    const anyRows = state.rows.length>0;
    if (anyRows) showTable();
    compute(); saveToUrl(); equalizeDetailHeights();
  }

  /* ---------- Income & Bars ---------- */
  function satMineralsPerBase(){
    const W = Math.max(0, Number(get("workersPerBase").value)||0);
    const w12 = Math.min(16, W);
    const w3  = Math.max(0, Math.min(8, W-16));
    return (w12 * 40) + (w3 * 20);
  }
  function satGasPerBase(){return Number(get("geysersPerBase").value)*Number(get("gasPerGeyserMin").value);}
  function muleIncomePerMinute(){return Number(get("orbitals").value)*(60/Number(get("secTo50").value))*Number(get("muleYield").value);}

  /* ---------- Qualities & composition ---------- */
  const COUNTERS={
    light:["Hellion","Hellbat","Colossus","Adept","Baneling"],
    armored:["Marauder","Immortal","Cyclone","Void Ray"],
    air:["Viking","Corruptor","Phoenix","Stalker"],
    bio:["Archon","Hellbat","Baneling"],
    mech:["Immortal","Tempest","Marauder"],
    ground:["Liberator","Colossus","Lurker"]
  };
  const PREF_TO_LABEL={ light:"vs Light", armored:"vs Armored", air:"vs Air", bio:"vs Biological", ground:"vs Ground", massive:"vs Massive", all:"General", clumps:"vs Clumped" };
  function compShares(tgt){
    const total = tgt.reduce((s,x)=>s+x.count,0)||1;
    let light=0, armored=0, air=0, ground=0, bio=0, mech=0, aa=0;
    tgt.forEach(x=>{
      if(x.attrs.includes("light")) light+=x.count;
      if(x.attrs.includes("armored")) armored+=x.count;
      if(x.attrs.includes("air")) air+=x.count;
      if(x.attrs.includes("ground")) ground+=x.count;
      if(x.attrs.includes("bio")) bio+=x.count;
      if(x.attrs.includes("mech")) mech+=x.count;
      if(x.aa) aa+=x.count;
    });
    const groundOnly=ground/total, lowAA=1-(aa/total);
    return {light:light/total, armored:armored/total, air:air/total, ground:ground/total, bio:bio/total, mech:mech/total, groundOnly, lowAA};
  }
  function clamp01(x){return Math.max(0,Math.min(1,x));}
  function setQ(el,val){el.style.width=(val*100).toFixed(0)+"%";}
  function setQV(el,val){el.textContent=Math.round(val*100);}


  function compute(){
    recalcSupplyCap();
    const bases   = Number(get("bases").value)||0;
    const mIncome = bases*satMineralsPerBase() + muleIncomePerMinute();
    const gIncome = bases*satGasPerBase();

    const mArmy = Number(get("uMin").textContent)||0;
    const gArmy = Number(get("uGas").textContent)||0;

    const techM = Math.max(0, Number(get("resM")?.value) || 0);
    const techG = Math.max(0, Number(get("resG")?.value) || 0);

    const mTotalSpend = mArmy + techM;
    const gTotalSpend = gArmy + techG;

    get("numMinInc").textContent  = Math.round(mIncome) + "m";
    get("numMinSp").textContent   = Math.round(mArmy)   + "m";
    get("numMinTech").textContent = Math.round(techM)   + "m";
    get("numGasInc").textContent  = Math.round(gIncome) + "g";
    get("numGasSp").textContent   = Math.round(gArmy)   + "g";
    get("numGasTech").textContent = Math.round(techG)   + "g";

    state._bars = {
      m:{income:mIncome, spend:mTotalSpend, incEl:get("barMinInc"), spEl:get("barMinSp"), overEl:get("barMinOver")},
      g:{income:gIncome, spend:gTotalSpend, incEl:get("barGasInc"), spEl:get("barGasSp"), overEl:get("barGasOver")}
    };
    if (window._updateBars) requestAnimationFrame(window._updateBars);
    if (window._updateBars) window._updateBars();

    const mAvail = Math.max(0, mIncome - techM);
    const gAvail = Math.max(0, gIncome - techG);
    const scale  = (mAvail>0 || gAvail>0)
      ? Math.min(mAvail/(mArmy||1), gAvail/(gArmy||1), 1)
      : 0;

    computeActualArmy(scale);
  }

  function computeActualArmy(scale){
    const S = Number(get("actualSupply").value)||0;

    const items = state.rows.map(r=>{
      const info = unitLookup(r.name); if(!info) return null;
      const {u, race} = info;
      const uptimeF = Math.max(0, Math.min(100, Number(r.uptime ?? 100))) / 100;
      const perMin  = (u.t > 0 ? (60/u.t) : 0) * (Number(r.count)||0) * uptimeF * scale;
      // const eff = Math.max(0.1, Number(get("eff").value)||0.6);
      const base = baseDps(u), peak = maxDps(u);
      const dps = base;
      const dpsMax = peak;
      const armor = u.armor;
      const hp = u.hp + u.sh;
      const costW = (u.m + u.g);
      return {name:r.name, rate:perMin, sup:u.sup, hp, dps, dpsMax, armor, costW,
              flags:u.flags, aa:u.tags.includes("aa"), heals:u.flags.heals,
              micro:u.micro, attrs:u.attrs, pref:u.pref, cap:r.cap ?? null};
    }).filter(Boolean);

    // Phase 1: pre-allocate caps
    let remainingS = S;
    const tgt = [];
    items.forEach(x=>{
      if(x.cap==null) return;
      const take = Math.min(x.cap, Math.floor(remainingS / Math.max(1,x.sup)));
      if(take>0){ tgt.push({...x, count:take}); remainingS -= take * x.sup; }
    });

    // Phase 2: distribute remaining among uncapped by rate
    const flex = items.filter(x=>x.cap==null);
    const totalRate = flex.reduce((s,x)=>s+x.rate,0);
    if(remainingS>0 && totalRate>0){
      const provisional = flex.map(x=>{
        const idealS = remainingS * (x.rate/totalRate);
        const cnt = Math.max(0, Math.floor(idealS / x.sup));
        const rem = (idealS/x.sup) - cnt;
        return {...x, count:cnt, rem};
      });
      let usedS = provisional.reduce((s,x)=>s+x.count*x.sup,0);
      const order = provisional.slice().sort((a,b)=>b.rem - a.rem);
      while (true){
        const can = order.find(it => usedS + it.sup <= remainingS);
        if(!can) break;
        can.count += 1; usedS += can.sup;
      }
      tgt.push(...provisional);
    }

    // ===== Time to build (discrete cycles) =====
    function streamsFor(name){
      const row = state.rows.find(r=>r.name===name);
      return Math.max(0, row ? Number(row.count)||0 : 0);
    }
    function timeForUnitSec(name, count, buildSec){
      const s = streamsFor(name);
      if(count<=0 || s<=0) return 0;
      const effStreams = Math.max(1, Math.min(s, count));
      return Math.ceil(count/effStreams) * buildSec;
    }

    let _timeBuildSec = 0;
    tgt.forEach(x=>{
      const Ux = T[x.name] || P[x.name] || Z[x.name];
      if(!Ux) return;
      const unitTime = timeForUnitSec(x.name, x.count, Number(Ux.t)||0);
      if(unitTime > _timeBuildSec) _timeBuildSec = unitTime;
    });
    const tEl = get("timeBuild"), bEl = get("timeBar");
    if(_timeBuildSec>0 && Number.isFinite(_timeBuildSec)){
      tEl.textContent = `${_timeBuildSec.toFixed(1)} s`;
      const frac = Math.max(0, Math.min(1, _timeBuildSec / BAR_MAX_SEC));
      bEl.style.width = (frac*100).toFixed(0) + "%";
    }else{
      tEl.textContent = "—";
      bEl.style.width = "0%";
    }

    // ===== Summaries =====
    const usedS = tgt.reduce((s,x)=>s + x.count*x.sup, 0);
    const totalUnits=tgt.reduce((s,x)=>s+x.count,0);
    const hp=tgt.reduce((s,x)=>s+x.hp*x.count,0);
    const dps=tgt.reduce((s,x)=>s+x.dps*x.count,0);
    const dpsMax=tgt.reduce((s,x)=>s+x.dpsMax*x.count,0);
    const armorAvg= totalUnits? tgt.reduce((s,x)=>s+x.armor*x.count,0)/totalUnits : 0;
    const det=tgt.some(x=>x.flags.detector), bur=tgt.some(x=>x.flags.burrow), clk=tgt.some(x=>x.flags.cloak), aa=tgt.some(x=>x.aa);
    const heals=tgt.some(x=>x.flags.heals);
    const compStr = tgt.filter(x=>x.count>0).map(x=>`${x.name}: ${x.count}`).join(" • ");

    get("analysisWrap").style.display = tgt.length? "" : "none";
    get("actualSummary").innerHTML = `
      ${totalUnits} units | ${dps.toFixed(1)} Avg DPS | ${dpsMax.toFixed(1)} Peak DPS
      <span class="comp">${compStr || "—"}</span>
    `;
    get("actualTotals").textContent = `HP ${hp.toLocaleString()} | Armor ${armorAvg.toFixed(2)}`;
    setAFlags(
      root, det, bur, clk, aa,
      (get("race").value==="Protoss"),
      (get("race").value==="Terran" && Number(get("orbitals").value)>0),
      (get("race").value==="Zerg"),
      heals
    );

    const costW = tgt.reduce((s,x)=>s + x.costW*x.count,0);
    renderQualities({hp:hp,sup:usedS,dps:dps,armor:armorAvg,
                     flags:{det,bur,clk,aa,recall:(get("race").value==="Protoss"),
                            scans:(get("race").value==="Terran"),
                            creep:(get("race").value==="Zerg"),heals},
                     costW}, tgt);

    // Composition sidebars
    const shares= (function(){
      const total = tgt.reduce((s,x)=>s+x.count,0)||1;
      let light=0, armored=0, air=0, ground=0, bio=0, mech=0, aa=0;
      tgt.forEach(x=>{
        if(x.attrs.includes("light")) light+=x.count;
        if(x.attrs.includes("armored")) armored+=x.count;
        if(x.attrs.includes("air")) air+=x.count;
        if(x.attrs.includes("ground")) ground+=x.count;
        if(x.attrs.includes("bio")) bio+=x.count;
        if(x.attrs.includes("mech")) mech+=x.count;
        if(x.aa) aa+=x.count;
      });
      const groundOnly=ground/total, lowAA=1-(aa/total);
      return {light:light/total, armored:armored/total, air:air/total, ground:ground/total, bio:bio/total, mech:mech/total, groundOnly, lowAA};
    })();
    const g = get;
    g("compBreak").textContent=
      `Light ${Math.round(shares.light*100)}% • Armored ${Math.round(shares.armored*100)}% • `+
      `Ground ${Math.round(shares.ground*100)}% • Air ${Math.round(shares.air*100)}% • `+
      `Bio ${Math.round(shares.bio*100)}% • Mech ${Math.round(shares.mech*100)}%`;

    const weakCats=[];
    if(shares.light>0.35) weakCats.push("light");
    if(shares.armored>0.35) weakCats.push("armored");
    if(shares.air>0.25) weakCats.push("air");
    if(shares.bio>0.35) weakCats.push("bio");
    if(shares.mech>0.35) weakCats.push("mech");
    if(shares.ground>0.75) weakCats.push("ground");
    const counterList=[...new Set(weakCats.flatMap(c=>COUNTERS[c]||[]))];
    g("compCounters").textContent=counterList.length? counterList.join(" • ") : "No obvious hard counters (composition-wise).";

    const dpsByPref={};
    const totalDps=tgt.reduce((s,x)=>s+x.dps*x.count,0)||1;
    tgt.forEach(x=>{ (x.pref||[]).forEach(p=>{dpsByPref[p]=(dpsByPref[p]||0)+x.dps*x.count;}); });
    const lines=Object.entries(dpsByPref).sort((a,b)=>b[1]-a[1]).slice(0,4)
      .map(([k,v])=>`${PREF_TO_LABEL[k]||k}: ${Math.round(100*v/totalDps)}% of DPS`);
    g("bonusProfile").textContent=lines.length? lines.join(" • ") : "Generalist: no strong bonus-damage focus.";
  }

  /* Single attachment point for all inputs on this side */
  root.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", ()=>{
      if (el === get("race")) {
        clampOrbitals(); renderRows(); compute(); saveToUrl();
      } else if (el === get("bases") || el === get("workersPerBase")) {
        clampOrbitals(); recalcSupplyCap(); compute(); saveToUrl();
      } else if (el === get("orbitals")) {
        clampOrbitals(); compute(); saveToUrl();
      } else {
        compute(); saveToUrl();
      }
    });
  });

  /* Add-row button */
  get("addRow").addEventListener("click", () => {
    const { U } = raceData();
    const first = Object.keys(U).sort()[0] || "Marine";
    state.rows.push({ name:first, count:1, uptime:100, cap:null });
    renderRows(); compute(); saveToUrl();
  });

  function populateUnitSelect(selEl, selected){
    const { U } = raceData();
    selEl.innerHTML = "";

    if (selected && !U[selected]) {
      const info = (T[selected] && {race:"Terran"}) || (P[selected] && {race:"Protoss"}) || (Z[selected] && {race:"Zerg"}) || null;
      const o = document.createElement("option");
      o.value = selected;
      o.textContent = info ? `${selected} (${info.race})` : selected;
      o.dataset.preserved = "1";
      selEl.appendChild(o);
    }

    Object.keys(U).sort().forEach(name => {
      const o = document.createElement("option");
      o.value = name; o.textContent = name;
      selEl.appendChild(o);
    });

    selEl.value = selected;
    if (selEl.value !== selected) selEl.selectedIndex = 0;

    selEl.addEventListener("change", (e) => {
      const tr  = e.target.closest("tr");
      const idx = Array.from(tbody.children).indexOf(tr);
      if (idx >= 0) {
        state.rows[idx].name = e.target.value;
        renderRows(); compute(); saveToUrl();
      }
    }, { once:true });
  }

  refreshUnitOptions(); renderRows();

  return {
    getState(){return{
      race:get("race").value,bases:Number(get("bases").value)||0,orbitals:Number(get("orbitals").value)||0,
      workersPerBase:Number(get("workersPerBase").value)||16,
      mineralsPerPatch:Number(get("mineralsPerPatch").value),
      gasPerGeyserBank:Number(get("gasPerGeyserBank").value),gasPerGeyserMin:Number(get("gasPerGeyserMin").value),
      muleYield:Number(get("muleYield").value),secTo50:Number(get("secTo50").value),
      rows:state.rows, actualSupply:Number(get("actualSupply").value)||120,
      resM: Number(get("resM").value)||0,
      resG: Number(get("resG").value)||0,
    };},
    setState(s){
      const g = get;
      g("race").value=s.race||"Terran";
      g("bases").value=s.bases??2; g("orbitals").value=s.orbitals??2;
      g("workersPerBase").value = s.workersPerBase ?? 16;
      g("mineralsPerPatch").value=s.mineralsPerPatch??1500;
      g("gasPerGeyserBank").value=s.gasPerGeyserBank??2250; g("gasPerGeyserMin").value=s.gasPerGeyserMin??160;
      g("muleYield").value=s.muleYield??225; g("secTo50").value=s.secTo50??88.9;
      g("actualSupply").value=s.actualSupply??120;
      g("resM").value = s.resM ?? 0;
      g("resG").value = s.resG ?? 0;
      clampOrbitals();
      state.rows = (Array.isArray(s.rows)? s.rows : []).map(r=>({
        name: r.name,
        count: Math.max(0, Number(r.count)||0),
        uptime: (r.uptime==null ? 100 : Math.max(0, Math.min(100, Number(r.uptime)||0))),
        cap: (r.cap==null || r.cap==="" ? null : Math.max(0, Number(r.cap)||0))
      }));
      refreshUnitOptions(); renderRows(); recalcSupplyCap();
    },
    root,
    getBars: ()=> state._bars || null
  };
}

/* --------- Right side cloning --------- */
function buildRight(){
  const left  = document.getElementById("sideL");
  const right = document.getElementById("sideR");
  const toClone = Array.from(left.children).slice(1);
  const frag = document.createDocumentFragment();
  toClone.forEach(node => frag.appendChild(node.cloneNode(true)));
  right.appendChild(frag);

  // Fix IDs: l-* -> r-*
  right.querySelectorAll("[id^='l-']").forEach(el => {
    const newId = el.id.replace(/^l-/, "r-");
    right.querySelectorAll(`label[for="${el.id}"]`).forEach(lb => lb.htmlFor = newId);
    el.id = newId;
  });
}

window._updateBars = function updateBars(){
  if (!window.L || !window.R) return;

  function setByDenom(income, spend, denom, incEl, spEl, overEl){
    const incPct  = Math.min(income/denom, 1) * 100;
    const spPct   = Math.min(spend/denom, 1)  * 100;
    const overPct = Math.max(0, (spend - income)/denom) * 100;
    incEl.style.width  = incPct.toFixed(2)+'%';
    spEl .style.width  = Math.min(spPct, incPct).toFixed(2)+'%';
    overEl.style.width = overPct.toFixed(2)+'%';
    overEl.style.left  = incPct.toFixed(2)+'%';
  }

  [window.L, window.R].forEach(app=>{
    // Skip the right app entirely when hidden
    if (!app || (document.body.classList.contains('hideR') && app === window.R)) return;
    const p = app.getBars?.();
    if (!p) return;

    // denom is computed from THIS side only
    const denomM = Math.max(1, p.m.income, p.m.spend);
    const denomG = Math.max(1, p.g.income, p.g.spend);

    setByDenom(p.m.income, p.m.spend, denomM, p.m.incEl, p.m.spEl, p.m.overEl);
    setByDenom(p.g.income, p.g.spend, denomG, p.g.incEl, p.g.spEl, p.g.overEl);
  });
};


/* --------- Equalize details heights (paired) --------- */
function equalizeDetailHeights(){
  if (document.body.classList.contains('hideR')){
    document.querySelectorAll("#sideL details.card, #sideR details.card")
      .forEach(el=> el.style.minHeight = "");
    return;
  }
  const Ls = Array.from(document.querySelectorAll("#sideL details.card"));
  const Rs = Array.from(document.querySelectorAll("#sideR details.card"));
  const n = Math.min(Ls.length, Rs.length);

  for (let i=0;i<n;i++){
    Ls[i].style.minHeight = "";
    Rs[i].style.minHeight = "";
  }

  for (let i=0;i<n;i++){
    const Lopen = Ls[i].open, Ropen = Rs[i].open;
    if (Lopen && Ropen){
      requestAnimationFrame(()=>{
        const h = Math.max(Ls[i].getBoundingClientRect().height, Rs[i].getBoundingClientRect().height);
        Ls[i].style.minHeight = h + "px";
        Rs[i].style.minHeight = h + "px";
      });
    } else {
      Ls[i].style.minHeight = "";
      Rs[i].style.minHeight = "";
    }
  }
}

/* --------- Keep L/R details open/closed in sync --------- */
function syncDetails(){
  const lD = Array.from(document.querySelectorAll("#sideL details.card"));
  const rD = Array.from(document.querySelectorAll("#sideR details.card"));
  function link(a,b){
    a.addEventListener("toggle", ()=>{
      b.open = a.open;
      requestAnimationFrame(equalizeDetailHeights);
    });
    b.addEventListener("toggle", ()=>{
      a.open = b.open;
      requestAnimationFrame(equalizeDetailHeights);
    });
  }
  const n = Math.min(lD.length, rD.length);
  for(let i=0;i<n;i++) link(lD[i], rD[i]);
}


/* ============================ BOOT ============================ */
(async () => {
  let data;
  console.log("Starting app...");
  try {
    const resp = await fetch('data.min.json', { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    data = await resp.json();
  } catch (e) {
    fatal(`Could not load data.min.json (${e.message}).`);
    return;
  }

  if (!data?.T || !data?.P || !data?.Z){
    fatal("data.min.json is missing one or more of: T, P, Z.");
    return;
  }

  T = data.T; P = data.P; Z = data.Z;

  normalizeAll();

  computeBarMaxSec();
  GLOBAL_CAPS = computeCapsOnce();

  console.log("Data loaded and normalized, building UI...");

  // Build right side UI and init apps
  buildRight();
  window.L = App("sideL");
  window.R = App("sideR");

  /* --------- URL/save state helpers --------- */
  function encodeState(){
    const s = {
      title: (document.getElementById("buildNameGlobal")?.value || "").trim(),
      L: L.getState(),
      R: R.getState(),
      showR: !document.body.classList.contains('hideR')
    };
    return btoa(unescape(encodeURIComponent(JSON.stringify(s))));
  }
  function decodeState(s){
    try{ return JSON.parse(decodeURIComponent(escape(atob(s)))); }catch{ return null; }
  }
  window._saveState = function(){
    const b=encodeState();
    history.replaceState(null,"","#s="+b);
  };

  // First bar sync after both apps exist
  if (window._updateBars) window._updateBars();
  equalizeDetailHeights();
  syncDetails();

  // Show/Hide Team 2
  const cbShowR = document.getElementById('toggleTeam2');
  if (cbShowR){
    cbShowR.addEventListener('change', ()=>{
      document.body.classList.toggle('hideR', !cbShowR.checked);
      equalizeDetailHeights();
      if (window._updateBars) window._updateBars();
      window._saveState();
    });
  }

  // Load from URL (fixed showR logic)
  (function loadFromUrl(){
    const m  = location.hash.match(/#s=([^]+)/);
    const cb = document.getElementById('toggleTeam2');
    const defaultShowR = !!cb?.checked;

    if (!m){
      document.body.classList.toggle('hideR', !defaultShowR);
      if (window._updateBars) window._updateBars();
      window._saveState();
      return;
    }

    const parsed = decodeState(m[1]);
    if (parsed && parsed.L && parsed.R){
      window._bootLoading = true;

      const titleEl = document.getElementById('buildNameGlobal');
      if (titleEl) titleEl.value = parsed.title || parsed?.L?.name || parsed?.R?.name || "";

      const showR = parsed.showR === true; // ✅ respect saved value
      document.body.classList.toggle('hideR', !showR);
      if (cb) cb.checked = showR;

      L.setState(parsed.L);
      R.setState(parsed.R);

      window._bootLoading = false;
      if (window._updateBars) window._updateBars();
      return;
    }

    document.body.classList.toggle('hideR', !defaultShowR);
    if (window._updateBars) window._updateBars();
    window._saveState();
  })();

  // Copy URL
  document.getElementById("copyUrl").addEventListener("click", async ()=>{
    window._saveState();
    try{
      await navigator.clipboard.writeText(location.href);
      document.getElementById("copyMsg").textContent="Copied!";
    }catch{
      document.getElementById("copyMsg").textContent="URL in address bar";
    }
  });

  // PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }
})().catch(e => fatal(`Boot failed: ${e.message}`));

</script>

</body>
</html>
